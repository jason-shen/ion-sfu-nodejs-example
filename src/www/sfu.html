<html>
<head>
</head>
<body>
Local Video
<div id="localVideos"></div>
<button onclick="window.publish()">Publish</button><br />


Remote Video<br />
<div id="remoteVideos"></div>
<br />

Logs<br />
<div id="logs"></div>

<script>
  function uuid() {
        var uuid = "", i, random;
        for (i = 0; i < 32; i++) {
            random = Math.random() * 16 | 0;

            if (i == 8 || i == 12 || i == 16 || i == 20) {
                uuid += "-"
            }
            uuid += (i == 12 ? 4 : (i == 16 ? (random & 3 | 8) : random)).toString(16);
        }
        return uuid;
    }
    function log(msg) {
        document.getElementById("logs").innerHTML += msg + '<br>'
    }
    let config = {
        iceServers: [{
            urls: 'stun:stun.l.google.com:19302'
        }]
    }

    let socket = new WebSocket("ws://localhost:8080");
    let pcPub = new RTCPeerConnection(config)
    let pcSub = new RTCPeerConnection(config)
    let myid;

    socket.onmessage = function(event) {
      messageHandler(event);
    }

    function messageHandler(event) {
        let parseMessage = JSON.parse(event.data)
        switch (parseMessage.type) {
            case "offer":
                onOffer(parseMessage)
                break;
            case "answer":
                onAnswer(parseMessage)
                break;
            case "trickle":
                onTrickle(parseMessage)
                console.log(parseMessage)
                break;
            default:
                console.error("unknown", parseMessage)
        }
    }

    async function onOffer(event) {
        if (!event.id) {
          log("got offer notification");
            console.log("@@@resp.desc", event.data)
            await pcSub.setRemoteDescription(event.data).catch(function(e) {
                console.log(e);
            })
            const answer = await pcSub.createAnswer().catch(function(e) {
                console.log(e)
            })
            console.log("answer", answer)
            await pcSub.setLocalDescription(answer).catch(function(e) {
                console.log(e)
            })

            const id = uuid()
            log(`Sending answer`)
            socket.send(JSON.stringify({
                type: "answer",
                data: { desc: answer },
                id
            }))
        }
    }

    async function onTrickle(event) {
      console.log("trickle recieved!!!! ", event.data.candidate, "taget@@ ", event.data.target)
             // pcPub.addIceCandidate(event.data.candidate).catch(log);
                if (event.data.target === 0) {
                    console.log("set Can pub")
                    pcPub.addIceCandidate(event.data.candidate).catch(e => {
                        log("pub error", e)
                    });
                }

                if (event.data.target === 1) {
                    console.log("set Can sub")
                            pcSub.addIceCandidate(event.data.candidate).catch(e => {
                                log("sub error", e)
                            });
            }
    }

   async function onAnswer(event) {
      console.log("on Answer@@", event, "myid: ", myid);
        if (event.id === myid) {
                log(`Got publish answer`)
                // Hook this here so it's not called before joining
                pcSub.onnegotiationneeded = async function () {
                    log("Renegotiating")
                    const offer = await pcSub.createOffer()
                    await pcSub.setLocalDescription(offer)
                    const id = uuid()
                    let message = {
                        type: "offer",
                        data: {
                            desc: offer,
                            id
                              }
                            }
                    socket.send(JSON.stringify(message))
                    console.log("send offer")

                    socket.addEventListener('message', (event) => {
                        const resp = JSON.parse(event.data)
                        if (resp.id === id) {
                            log(`Got renegotiation answer`)
                            pcSub.setRemoteDescription(resp.data).catch(function (e) {
                                console.log(e)
                            });
                        }
                    })
                }
                console.log("set remote ", event.data)
                pcPub.setRemoteDescription(event.data).catch(function(e) {
                    console.log("error here ", e)
                })
            }
    }


    pcPub.ontrack = function ({track, streams}) {
        if (track.kind === 'video') {
            log("got track");
            track.onunmute = function() {
                let el = document.createElement(track.kind)
                el.srcObject = streams[0]
                el.autoplay = true;
                document.getElementById("remoteVideos").appendChild(el);
            }
        }
    }

    pcSub.ontrack = function ({track, streams}) {
        if (track.kind === 'video') {
            log("got track pc sub");
            console.log("track", track);
            console.log("stream ", streams);
            track.onunmute = function() {
                let el = document.createElement(track.kind)
                el.srcObject = streams[0]
                el.autoplay = true;
                document.getElementById("remoteVideos").appendChild(el);
            }
        }
    }

    pcPub.oniceconnectionstatechange = function (e) {
        log(`ICE connection state: ${pcPub.iceConnectionState}`)
    }

    pcSub.oniceconnectionstatechange = function (e) {
        log(`ICE connection state: ${pcPub.iceConnectionState}`)
    }

    pcPub.onicecandidate = function (event) {
        let candidate = event.candidate;
        if (pcPub.signalingState === "stable") {
        if (candidate !== null) {
            let message = {
                type: "trickle",
                data: {
                    candidate,
                    target: 0
                }
            }
            socket.send(JSON.stringify(message))
            console.log("send trickle", message);
        }
      }
    }

    pcSub.onicecandidate = function (event) {
        let candidate = event.candidate;
        if (pcSub.signalingState === "stable") {
        if (candidate !== null) {
            let message = {
                type: "trickle",
                data: {
                    candidate,
                    target: 1
                }
            }
            socket.send(JSON.stringify(message))
            console.log("send trickle", message);
        }
      }
    }

   async function join() {
      const offer = await pcPub.createOffer()
        await pcPub.setLocalDescription(offer)
         myid = uuid();

         const message = {
                        type: "joinRoom",
                        data: {
                            sid: "sample",
                            offer: pcPub.localDescription,
                            id: myid
                        }
                    }
        console.log("join message", message);
        socket.send(JSON.stringify(message))
    }

    let localStream
    let pid
    navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
    }).then(stream => {
        let el = document.createElement("Video")
        el.srcObject = stream
        el.autoplay = true
        el.controls = true
        el.muted = true
        document.getElementById('localVideos').appendChild(el)

        localStream = stream
    }).catch(log)

    window.publish = () => {
        log("Publishing stream")
        localStream.getTracks().forEach((track) => {
            pcPub.addTrack(track, localStream);
        });

        join()
    }
</script>
</body>
</html>